{% extends 'base.html' %}
{% load static %}

{% block title %}–ù–∞—à—ñ –º–æ–º–µ–Ω—Ç–∏ –∑ —ñ–≥–æ—Ä —Ç–∞ –≥–µ–π–º–¥–∂–µ–º—ñ–≤{% endblock %}

{% block content %}
<div>
    <div>
        <h1>üéÆ –ù–∞—à—ñ –º–æ–º–µ–Ω—Ç–∏ –∑ —ñ–≥–æ—Ä —Ç–∞ –≥–µ–π–º–¥–∂–µ–º—ñ–≤</h1>
        <p>–ù–∞–π–∫—Ä–∞—â—ñ —Å–∫—Ä—ñ–Ω—à–æ—Ç–∏, —Ñ–æ—Ç–æ —Ç–∞ –≤—ñ–¥–µ–æ –∑ –Ω–∞—à–∏—Ö –ø—Ä–∏–≥–æ–¥</p>
    </div>

    <div>
        <div>
            {% if user.is_authenticated %}
                <a href="{% url 'gallery:create' %}">
                    <i></i> –î–æ–¥–∞—Ç–∏ –º–µ–¥—ñ–∞—Ñ–∞–π–ª
                </a>
            {% endif %}
        </div>
        <div>
            {% if user.is_staff or user.is_superuser %}
                <a href="{% url 'gallery:moderation' %}">
                    <i></i> –ú–æ–¥–µ—Ä–∞—Ü—ñ—è
                </a>
            {% endif %}
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div>
                {{ message }}
                <button type="button">Close</button>
            </div>
        {% endfor %}
    {% endif %}

    {% if total_items > 0 %}
    <div>
        <div>
            <div>
                <h3>{{ total_items }}</h3>
                <p>–ú–µ–¥—ñ–∞—Ñ–∞–π–ª—ñ–≤</p>
            </div>
            <div>
                <h3>{{ games|length }}</h3>
                <p>–Ü–≥–æ—Ä</p>
            </div>
            <div>
                <h3>{{ page_obj.paginator.num_pages }}</h3>
                <p>–°—Ç–æ—Ä—ñ–Ω–æ–∫</p>
            </div>
        </div>
    </div>
    {% endif %}

    <div>
        <form method="get" id="filterForm">
            <div>
                <input type="text" 
                       name="search" 
                       placeholder="üîç –ü–æ—à—É–∫ –ø–æ –Ω–∞–∑–≤—ñ, –æ–ø–∏—Å—É –∞–±–æ –≥—Ä—ñ..."
                       value="{{ search_query }}">
            </div>

            <div>
                <label><i></i> –¢–∏–ø –º–µ–¥—ñ–∞:</label>
                <div>
                    <button type="button" onclick="filterByType('')">
                        <i></i> –í—Å—ñ
                    </button>
                    {% for type_code, type_name in media_types %}
                        {% if type_code != 'other' and type_code != 'unknown' %}
                        <button type="button" onclick="filterByType('{{ type_code }}')">
                            {% if type_code == 'photo' %}
                                <i></i>
                            {% elif type_code == 'screenshot' %}
                                <i></i>
                            {% elif type_code == 'video' %}
                                <i></i>
                            {% endif %}
                            {{ type_name }}
                        </button>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            {% if games %}
            <div>
                <label><i></i> –ì—Ä–∞:</label>
                <div>
                    <button type="button" onclick="filterByGame('')">
                        –í—Å—ñ —ñ–≥—Ä–∏
                    </button>
                    {% for game in games %}
                    <button type="button" onclick="filterByGame('{{ game }}')">
                        {{ game }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <input type="hidden" name="type" id="typeInput" value="{{ current_type }}">
            <input type="hidden" name="game" id="gameInput" value="{{ current_game }}">
        </form>
    </div>

    {% if items %}
        <div>
            {% for item in items %}
                <div>
                    <div>
                        <div>
                            <a href="{% url 'gallery:detail' item.pk %}">
                                {% if item.is_image %}
                                    <img src="{{ item.file.url }}" alt="{{ item.title }}">
                                {% else %}
                                    <div>
                                        <i></i>
                                    </div>
                                {% endif %}
                            </a>
                            
                            <span>
                                {{ item.get_media_type_display }}
                            </span>
                        </div>
                        
                        <div>
                            <h5>
                                <a href="{% url 'gallery:detail' item.pk %}">
                                    {{ item.title }}
                                </a>
                            </h5>
                            
                            {% if item.description %}
                                <p>{{ item.description|truncatewords:15 }}</p>
                            {% endif %}
                            
                            <div>
                                <small>
                                    <i></i> {{ item.author.username|default:"–ê–Ω–æ–Ω—ñ–º" }}
                                </small>
                                <br>
                                <small>
                                    <i></i> {{ item.created_at|date:"d.m.Y" }}
                                </small>
                            </div>

                            {% if item.game_name %}
                                <span>
                                    <i></i> {{ item.game_name }}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        {% if is_paginated %}
            <nav>
                <ul>
                    {% if page_obj.has_previous %}
                        <li>
                            <a href="?page=1{% if current_type %}&type={{ current_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if current_game %}&game={{ current_game }}{% endif %}">
                                –ü–µ—Ä—à–∞
                            </a>
                        </li>
                        <li>
                            <a href="?page={{ page_obj.previous_page_number }}{% if current_type %}&type={{ current_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if current_game %}&game={{ current_game }}{% endif %}">
                                –ü–æ–ø–µ—Ä–µ–¥–Ω—è
                            </a>
                        </li>
                    {% endif %}

                    <li>
                        <span>
                            {{ page_obj.number }} –∑ {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>

                    {% if page_obj.has_next %}
                        <li>
                            <a href="?page={{ page_obj.next_page_number }}{% if current_type %}&type={{ current_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if current_game %}&game={{ current_game }}{% endif %}">
                                –ù–∞—Å—Ç—É–ø–Ω–∞
                            </a>
                        </li>
                        <li>
                            <a href="?page={{ page_obj.paginator.num_pages }}{% if current_type %}&type={{ current_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if current_game %}&game={{ current_game }}{% endif %}">
                                –û—Å—Ç–∞–Ω–Ω—è
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}
    {% else %}
        <div>
            <i></i>
            <h3>–ì–∞–ª–µ—Ä–µ—è –ø–æ–∫–∏ —â–æ –ø–æ—Ä–æ–∂–Ω—è</h3>
            <p>
                {% if search_query or current_type or current_game %}
                    –ó–∞ –≤–∞—à–∏–º–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—è–º–∏ –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏.
                {% else %}
                    {% if user.is_authenticated %}
                        –ë—É–¥—å—Ç–µ –ø–µ—Ä—à–∏–º, —Ö—Ç–æ –¥–æ–¥–∞—Å—Ç—å –º–µ–¥—ñ–∞—Ñ–∞–π–ª!
                    {% else %}
                        –£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –¥–æ–¥–∞—Ç–∏ —Å–≤—ñ–π –º–µ–¥—ñ–∞—Ñ–∞–π–ª.
                    {% endif %}
                {% endif %}
            </p>
            {% if search_query or current_type or current_game %}
                <a href="{% url 'gallery:list' %}">
                    <i></i> –°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
function filterByType(type) {
    document.getElementById('typeInput').value = type;
    document.getElementById('filterForm').submit();
}

function filterByGame(game) {
    document.getElementById('gameInput').value = game;
    document.getElementById('filterForm').submit();
}

let searchTimeout;
document.querySelector('input[name="search"]').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        document.getElementById('filterForm').submit();
    }, 500);
});
</script>
{% endblock %}