{% block content %}
<div>
    <h1>
        {{ topic.title }}
        {% if topic.is_pinned %}üìå{% endif %}
        {% if topic.is_locked %}üîí{% endif %}
    </h1>
    
    <p>
        –ö–∞—Ç–µ–≥–æ—Ä—ñ—è: 
        <a href="{% url 'forum:topic_list_by_category' topic.forum.category.id %}">
            {{ topic.forum.category.name }}
        </a>
    </p>

    {% if user == topic.author or user.is_staff %}
        <div>
            <a href="{% url 'forum:topic_update' topic.pk %}">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a> |
            <a href="{% url 'forum:topic_delete' topic.pk %}">–í–∏–¥–∞–ª–∏—Ç–∏</a>
        </div>
    {% endif %}

    {% if messages %}
        {% for message in messages %}
            <div>{{ message }}</div>
        {% endfor %}
    {% endif %}

    <h2>–í—ñ–¥–ø–æ–≤—ñ–¥—ñ</h2>

    {% for post in posts %}
        <div>
            <p><strong>{{ post.author.username }}</strong> - {{ post.created_at|date:"d.m.Y H:i" }} {% if post.is_edited %}(—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ){% endif %}</p>
            
            <p>{{ post.content|linebreaks }}</p>

            {% if forum_settings.enable_attachments and post.attachments.all %}
                <div>
                    <strong>–í–∫–ª–∞–¥–µ–Ω–Ω—è:</strong>
                    {% for att in post.attachments.all %}
                        {% if att.is_image %}
                            <div>
                                <a href="{{ att.file.url }}" target="_blank">
                                    <img src="{{ att.file.url }}" alt="–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è" style="max-width:200px;">
                                </a>
                            </div>
                        {% else %}
                            <div>
                                <a href="{{ att.file.url }}" download>üìé {{ att.file.name }}</a>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}

            {% if forum_settings.enable_likes or forum_settings.enable_dislikes %}
                <div>
                    {% if forum_settings.enable_likes %}
                        <form action="{% url 'forum:like_post' post.pk %}" method="post" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit">üëç {{ post.likes.count }}</button>
                        </form>
                    {% endif %}

                    {% if forum_settings.enable_dislikes %}
                        <form action="{% url 'forum:dislike_post' post.pk %}" method="post" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit">üëé {{ post.dislikes.count }}</button>
                        </form>
                    {% endif %}
                </div>
            {% endif %}
            <hr>
        </div>
    {% empty %}
        <p>–í—ñ–¥–ø–æ–≤—ñ–¥–µ–π —â–µ –Ω–µ–º–∞—î.</p>
    {% endfor %}

        {% if user.is_authenticated %}
        {% if not topic.is_locked %}
            <h3>–î–æ–¥–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</h3>
            <form action="{% url 'forum:topic_detail' topic.pk %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div>
                    {{ reply_form.content.label_tag }}
                    {{ reply_form.content }}
                    {% if reply_form.content.errors %}
                        <div style="color: red;">{{ reply_form.content.errors }}</div>
                    {% endif %}
                </div>

                {% if forum_settings.enable_attachments %}
                    <div>
                        <label for="id_attachments">–í–∫–ª–∞–¥–µ–Ω–Ω—è:</label>
                        <input type="file" name="attachments" id="id_attachments" multiple 
                            accept=".png,.jpg,.jpeg,.gif,.pdf,.zip,.rar,.7z,.txt,.mp4">
                        <small>–ú–æ–∂–Ω–∞ –æ–±—Ä–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ —Ñ–∞–π–ª—ñ–≤. –î–æ–∑–≤–æ–ª–µ–Ω—ñ: png, jpg, jpeg, gif, pdf, zip, rar, 7z, txt, mp4 (–º–∞–∫—Å. 10 –ú–ë –∫–æ–∂–µ–Ω)</small>
                        <div id="file-list"></div>
                    </div>
                {% endif %}

                <button type="submit">üì§ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
            </form>
        {% else %}
            <p>üîí –¢–µ–º–∞ –∑–∞–∫—Ä–∏—Ç–∞ –¥–ª—è –Ω–æ–≤–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π.</p>
        {% endif %}
    {% else %}
        <p>–©–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å, –±—É–¥—å –ª–∞—Å–∫–∞, <a href="{% url 'login' %}?next={{ request.path }}">—É–≤—ñ–π–¥—ñ—Ç—å</a>.</p>
    {% endif %}

    {% if user.is_staff %}
        <div>
            <h4>–î—ñ—ó –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞</h4>
            <form action="{% url 'forum:toggle_pin' topic.pk %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit">
                    {% if topic.is_pinned %}–í—ñ–¥–∫—Ä—ñ–ø–∏—Ç–∏{% else %}–ó–∞–∫—Ä—ñ–ø–∏—Ç–∏{% endif %} üìå
                </button>
            </form>

            <form action="{% url 'forum:toggle_lock' topic.pk %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit">
                    {% if topic.is_locked %}–í—ñ–¥–∫—Ä–∏—Ç–∏{% else %}–ó–∞–∫—Ä–∏—Ç–∏{% endif %} üîí
                </button>
            </form>
        </div>
    {% endif %}
</div>
{% endblock %}